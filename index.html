<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Calling System</title>
  <style>
    video {
      width: 300px;
      height: 200px;
      margin-bottom: 10px;
      border: 2px solid black;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>Video Calling System</h1>

  <!-- Local Video -->
  <video id="localVideo" autoplay muted></video>

  <!-- Remote Video -->
  <video id="remoteVideo" autoplay></video>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey:"AIzaSyDgY9qT22cGrA7d46axjzJT5g5EZ2SxsRw",
        authDomain: "mextube-2b3e3.firebaseapp.com",
        projectId: "mextube-2b3e3",
        storageBucket: "mextube-2b3e3.appspot.com",
        messagingSenderId: "821910922346",
        appId: "1:821910922346:web:b7f79bb310793978de1613"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Get a reference to the database service
    const database = firebase.firestore();

    // Set up WebRTC
    let localStream;
    let remoteStream;
    let localVideo = document.getElementById("localVideo");
    let remoteVideo = document.getElementById("remoteVideo");
    let peerConnection;

    // Get user media
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(function(stream) {
        localStream = stream;
        localVideo.srcObject = localStream;
      })
      .catch(function(error) {
        console.error("Error accessing media devices:", error);
      });

    // Create an RTCPeerConnection
    function createPeerConnection() {
      peerConnection = new RTCPeerConnection();

      // Add local stream to peer connection
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      // Set up event handlers
      peerConnection.ontrack = handleRemoteStreamAdded;
      peerConnection.onicecandidate = handleIceCandidate;
    }

    // Function to handle remote stream added
    function handleRemoteStreamAdded(event) {
      remoteStream = event.streams[0];
      remoteVideo.srcObject = remoteStream;
    }

    // Function to handle ICE candidates
    function handleIceCandidate(event) {
      if (event.candidate) {
        sendIceCandidate(event.candidate.toJSON());
      }
    }

    // Function to send ICE candidate to the other peer
    function sendIceCandidate(candidate) {
      // Send candidate to the other peer using Firebase Firestore or WebSocket
      // Example: database.collection("iceCandidates").add(candidate);
    }

    // Function to receive ICE candidate from the other peer
    function receiveIceCandidate(candidate) {
      // Add candidate to peer connection
      peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }

    // Function to start a call
    function startCall() {
      // Create peer connection
      createPeerConnection();

      // Offer session
      peerConnection.createOffer()
        .then(function(offer) {
          // Set local description
          return peerConnection.setLocalDescription(offer);
        })
        .then(function() {
          // Send offer to the other peer
          // Example: database.collection("offers").add(peerConnection.localDescription.toJSON());
        })
        .catch(function(error) {
          console.error("Error creating offer:", error);
        });
    }

    // Function to receive an offer from the other peer
    function receiveOffer(offer) {
      // Create peer connection
      createPeerConnection();

      // Set remote description
      peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
        .then(function() {
          // Create answer
          return peerConnection.createAnswer();
        })
        .then(function(answer) {
          // Set local description
          return peerConnection.setLocalDescription(answer);
        })
        .then(function() {
          // Send answer to the other peer
          // Example: database.collection("answers").add(peerConnection.localDescription.toJSON());
        })
        .catch(function(error) {
          console.error("Error creating answer:", error);
        });
    }

    // Function to receive an answer from the other peer
    function receiveAnswer(answer) {
      // Set remote description
      peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
        .catch(function(error) {
          console.error("Error setting remote description:", error);
        });
    }

    // Listen for offers from the other peer
    database.collection("offers").onSnapshot(function(snapshot) {
      snapshot.docChanges().forEach(function(change) {
        if (change.type === "added") {
          receiveOffer(change.doc.data());
        }
      });
    });

    // Listen for answers from the other peer
    database.collection("answers").onSnapshot(function(snapshot) {
      snapshot.docChanges().forEach(function(change) {
        if (change.type === "added") {
          receiveAnswer(change.doc.data());
        }
      });
    });

    // Listen for ICE candidates from the other peer
    database.collection("iceCandidates").onSnapshot(function(snapshot) {
      snapshot.docChanges().forEach(function(change) {
        if (change.type === "added") {
          receiveIceCandidate(change.doc.data());
        }
      });
    });

    // Start call when the button is clicked
    document.getElementById("startCallButton").addEventListener("click", startCall);
  </script>

  <!-- Button to start a call -->
  <button id="startCallButton">Start Call</button>
</body>
</html>

