<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Video Calling</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f1f1f1;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: stretch; /* Stretch container vertically */
    }

    #sidebar {
      width: 200px;
      background-color: #333;
      color: white;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #userList {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #userList button {
      margin-bottom: 5px;
    }

    #main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    h1 {
      color: #333;
    }

    #localVideo, #remoteVideo {
      width: 320px;
      height: 240px;
      margin: 10px;
      border: 2px solid #333;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Live Users</h2>
    <div id="userList"></div>
  </div>

  <div id="main">
    <h1>Live Video Calling</h1>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDgY9qT22cGrA7d46axjzJT5g5EZ2SxsRw",
    authDomain: "mextube-2b3e3.firebaseapp.com",
    databaseURL: "https://mextube-2b3e3-default-rtdb.firebaseio.com",
    projectId: "mextube-2b3e3",
    storageBucket: "mextube-2b3e3.appspot.com",
    messagingSenderId: "821910922346",
    appId: "1:821910922346:web:b7f79bb310793978de1613"
    };

    firebase.initializeApp(firebaseConfig);

    const database = firebase.database();
    const roomRef = database.ref("rooms");

    const configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    const peerConnection = new RTCPeerConnection(configuration);
    let localStream, remoteStream;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        document.getElementById("localVideo").srcObject = stream;
        peerConnection.addStream(stream);
      })
      .catch(error => console.error("Error accessing media devices:", error));

    const userListContainer = document.getElementById("userList");

    // Listen for changes in live users
    roomRef.on("child_added", snapshot => {
      const userName = snapshot.key;
      const userButton = document.createElement("button");
      userButton.textContent = userName;
      userButton.addEventListener("click", () => {
        // User clicked on another user's name, initiate connection
        connectToUser(userName);
      });
      userListContainer.appendChild(userButton);
    });

    // Listen for remote ICE candidates
    roomRef.child("candidates").on("child_added", snapshot => {
      const candidate = new RTCIceCandidate(snapshot.val());
      peerConnection.addIceCandidate(candidate);
    });

    // Listen for remote SDP messages
    roomRef.child("offer").on("value", async snapshot => {
      const offer = snapshot.val();
      if (offer) {
        await peerConnection.setRemoteDescription(offer);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        roomRef.child("answer").set(answer);
      }
    });

    // Listen for remote answer
    roomRef.child("answer").on("value", async snapshot => {
      const answer = snapshot.val();
      if (answer) {
        await peerConnection.setRemoteDescription(answer);
      }
    });

    // Send local ICE candidates to the other peer
    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        roomRef.child("candidates").push(event.candidate.toJSON());
      }
    };

    // Add remote stream to remote video element
    peerConnection.onaddstream = event => {
      remoteStream = event.stream;
      document.getElementById("remoteVideo").srcObject = remoteStream;
    };

    // Create and send offer to Firebase
    const createOffer = async () => {
      try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        roomRef.child("offer").set(offer);
      } catch (error) {
        console.error("Error creating offer:", error);
      }
    };

    // Create offer when local stream is available
    peerConnection.onnegotiationneeded = createOffer;

    // Start the call
    createOffer();

    // Function to initiate connection with another user
    function connectToUser(userName) {
      console.log("Connecting to user:", userName);
      // Implement your logic to accept the connection and notify the other user
    }
    
  </script>
</body>
</html>
